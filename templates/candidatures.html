<!-- jobs/templates/candidatures.html -->

{% extends 'base.html' %}
{% include './partials/_menu.html' %}

{% block main %}
<script>
    let showClosed = false;

    function toggleExpired(jobId) {
        fetch('/toggle_expired/' + jobId, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        }).then(() => {
            location.reload();
        });
    }
    
    function deleteJob(jobId) {
        if (confirm('√ätes-vous s√ªr de vouloir supprimer cette candidature ?')) {
            window.location.href = '/delete/' + jobId;
        }
    }

    function showLM(id) {
        // prefer desktop element, fallback to mobile
        const elt = document.getElementById('lm-content-desktop-' + id) || document.getElementById('lm-content-mobile-' + id);
        const modalBody = document.getElementById('lmModalBody');
        if (elt && modalBody) {
            // use textContent to avoid interpreting HTML
            modalBody.textContent = elt.textContent || elt.innerText || '';
            var myModal = new bootstrap.Modal(document.getElementById('lmModal'));
            myModal.show();
        }
    }

    function applyClosedFilter() {
        showClosed = document.getElementById('showClosed').checked;
        document.querySelectorAll('[data-closed]').forEach(el => {
            const isClosed = el.getAttribute('data-closed') === '1';
            if (isClosed && !showClosed) {
                el.classList.add('d-none');
            } else {
                el.classList.remove('d-none');
            }
        });

        // Re-order table rows in tbody according to data-order to preserve original sort
        try {
            const tbody = document.querySelector('table.table tbody');
            if (tbody) {
                const rows = Array.from(tbody.querySelectorAll('tr'));
                // server order is DESC (most recent first), sort client-side accordingly
                rows.sort((a, b) => Number(b.getAttribute('data-order') || 0) - Number(a.getAttribute('data-order') || 0));
                rows.forEach(r => tbody.appendChild(r)); // appendChild moves existing nodes
            }
        } catch (e) {
            console.debug('applyClosedFilter: table reorder failed', e);
        }

        // Re-order mobile cards container
        try {
            const cardsContainer = document.querySelector('div.d-lg-none');
            if (cardsContainer) {
                const cards = Array.from(cardsContainer.querySelectorAll('div.card'));
                // preserve server-side descending order
                cards.sort((a, b) => Number(b.getAttribute('data-order') || 0) - Number(a.getAttribute('data-order') || 0));
                cards.forEach(c => cardsContainer.appendChild(c));
            }
        } catch (e) {
            console.debug('applyClosedFilter: cards reorder failed', e);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        // initial state (checkbox checked by default)
        const cb = document.getElementById('showClosed');
        if (cb) {
            cb.checked = false;
        }
        applyClosedFilter();
    });
</script>
<div class="mb-3">
  <div class="d-flex justify-content-between align-items-center">
    <div>
      {% if not user.is_reader %}
        <a href="{{ url_for('new') }}" class="btn btn-primary btn-sm">‚ûï Ajouter une candidature</a>
      {% endif %}
    </div>
    <div>
      <!-- Filtre pour offres cl√¥tur√©es -->
      <div class="form-check form-switch d-inline-flex align-items-center" style="gap:0.5rem;">
        <input class="form-check-input" type="checkbox" id="showClosed" onchange="applyClosedFilter()" style="transform: scale(0.8); transform-origin: center;">
        <label class="form-check-label small mb-0" for="showClosed">Afficher les offres cl√¥tur√©es</label>
      </div>
    </div>
  </div>
</div>
<main class="container-fluid">
{% if jobs %}
    <!-- Desktop table -->
    <div class="d-none d-lg-block">
        <table class="table table-striped table-hover">
            <thead class="table-dark">
            <tr>
                {% if not user.is_reader %}<th>Update</th><th>Delete</th>{% endif %}
                <th>Offre</th><th>Capture</th><th>LM</th><th>Location</th><th>Company</th><th>Contact</th><th>E-Mail</th><th>Date candidature</th><th>Date relance</th><th>Date refus</th><th>Cl√¥tur√©e</th>
            </tr>
            </thead>
            <tbody>
            {% for job in jobs %}
            <tr class="{% if not job.active %}table-secondary{% endif %}" data-closed="{{ '1' if not job.active else '0' }}" data-order="{{ job.recent_ts }}">
                {% if not user.is_reader %}<td><a href="{{ url_for('update', id=job.id) }}" class="btn btn-sm btn-primary" title="Modifier #{{job.id}}">‚úèÔ∏è</a></td><td><button onclick="deleteJob({{ job.id }})" class="btn btn-sm btn-danger" title="Supprimer #{{job.id}}">üóëÔ∏è</button></td>{% endif %}
                <td><a href="{{ job.url }}" target="_blank">{{ job.name }}</a></td>
                <td>{% if job.is_capture %}{% set capture = 'images/' + ('capture_%s.pdf' % job.id) %}<a href="{{ url_for('static', filename=capture) }}" target="_blank" class="btn btn-sm btn-outline-success">PDF</a>{% else %}<span class="text-muted">‚åê</span>{% endif %}</td>
                <td>
                    {% if job.cover_letter_text %}
                        <span class="text-truncate d-inline-block" style="max-width:160px">{{ job.cover_letter_text }}</span>
                        <button type="button" class="btn btn-sm btn-link p-0 ms-2" onclick="showLM({{ job.id }})">Aper√ßu</button>
                        <div id="lm-content-desktop-{{ job.id }}" class="d-none">{{ job.cover_letter_text | e }}</div>
                    {% else %}
                        <span class="text-muted">‚Äî</span>
                    {% endif %}
                </td>
                <td>{{ job.zipCode }}</td><td>{{ job.company }}</td><td>{{ job.contact }}</td>
                <td class="{% if not job.email %}bg-warning{% endif %}">{{ job.email }}</td>
                <td class="{% if job.expired %}bg-danger text-white{% endif %}">{{job.applicationDate.strftime('%d/%m/%Y')}}</td>
                <td>{% if job.relaunchDate %}{{job.relaunchDate.strftime('%d/%m/%Y')}}{% endif %}</td>
                <td>{% if job.refusalDate %}{{job.refusalDate.strftime('%d/%m/%Y')}}{% endif %}</td>
                <td>
                    {% if not user.is_reader %}
                        {% if not job.active %}
                            <input type="checkbox" class="form-check-input" onchange="toggleExpired({{ job.id }})" aria-label="Marquer comme cl√¥tur√©e" checked>
                        {% else %}
                            <input type="checkbox" class="form-check-input" onchange="toggleExpired({{ job.id }})" aria-label="Marquer comme cl√¥tur√©e">
                        {% endif %}
                    {% else %}
                        {% if not job.active %}
                            <input type="checkbox" class="form-check-input" aria-label="Marquer comme cl√¥tur√©e" disabled checked>
                        {% else %}
                            <input type="checkbox" class="form-check-input" aria-label="Marquer comme cl√¥tur√©e" disabled>
                        {% endif %}
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- Mobile cards -->
    <div class="d-lg-none">
        {% for job in jobs %}
        <div class="card mb-2 {% if not job.active %}bg-light{% endif %}" data-closed="{{ '1' if not job.active else '0' }}" data-order="{{ job.recent_ts }}">
            <div class="card-body p-2">
                <div class="d-flex justify-content-between align-items-start mb-1">
                    <h6 class="card-title mb-0 small"><a href="{{ job.url }}" target="_blank">{{ job.name }}</a></h6>
                    {% if not user.is_reader %}
                        <a href="{{ url_for('update', id=job.id) }}" class="btn btn-sm btn-primary me-1" title="Modifier #{{job.id}}">‚úèÔ∏è</a>
                        <button onclick="deleteJob({{ job.id }})" class="btn btn-sm btn-danger" title="Supprimer #{{job.id}}">üóëÔ∏è</button>
                    {% endif %}
                </div>
                <div class="small text-muted mb-1"><strong>{{ job.company }}</strong> - {{ job.zipCode }}</div>
                <div class="small mb-1">{{ job.contact }} {% if job.email %}- {{ job.email }}{% endif %}</div>
                <div class="d-flex justify-content-between align-items-center small">
                    <span class="{% if job.expired %}bg-danger text-white px-1 rounded{% endif %}">{{job.applicationDate.strftime('%d/%m')}}</span>
                    <div>
                        {% if job.is_capture %}{% set capture = 'images/' + ('capture_%s.pdf' % job.id) %}<a href="{{ url_for('static', filename=capture) }}" target="_blank" class="btn btn-sm btn-outline-success py-0">PDF</a>{% endif %}
                        {% if job.cover_letter_text %}
                            <span class="ms-1 small text-truncate" style="max-width:120px">{{ job.cover_letter_text }}</span>
                            <button type="button" class="btn btn-sm btn-link p-0 ms-2" onclick="showLM({{ job.id }})">Aper√ßu</button>
                            <div id="lm-content-mobile-{{ job.id }}" class="d-none">{{ job.cover_letter_text | e }}</div>
                        {% endif %}
                        {% if not user.is_reader %}
                            {% if not job.active %}
                                <input type="checkbox" class="form-check-input ms-2" onchange="toggleExpired({{ job.id }})" title="Cl√¥tur√©e" aria-label="Marquer comme cl√¥tur√©e" checked>
                            {% else %}
                                <input type="checkbox" class="form-check-input ms-2" onchange="toggleExpired({{ job.id }})" title="Cl√¥tur√©e" aria-label="Marquer comme cl√¥tur√©e">
                            {% endif %}
                        {% else %}
                            {% if not job.active %}
                                <input type="checkbox" class="form-check-input ms-2" disabled title="Cl√¥tur√©e" aria-label="Marquer comme cl√¥tur√©e" checked>
                            {% else %}
                                <input type="checkbox" class="form-check-input ms-2" disabled title="Cl√¥tur√©e" aria-label="Marquer comme cl√¥tur√©e">
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="text-center mt-5"><p class="fs-5">Pas de candidature en cours ‚úåÔ∏è</p></div>
    {% endif %}
</main>

<!-- Modal for cover letter preview -->
<div class="modal fade" id="lmModal" tabindex="-1" aria-labelledby="lmModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="lmModalLabel">Aper√ßu - Lettre de motivation</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="lmModalBody" style="white-space:pre-wrap;"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
      </div>
    </div>
  </div>
</div>

{% endblock main %}