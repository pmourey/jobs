<!-- jobs/templates/candidatures.html -->

{% extends 'base.html' %}
{% include './partials/_menu.html' %}

{% block main %}
<script>
    function toggleExpired(jobId) {
        fetch('/toggle_expired/' + jobId, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        }).then(() => {
            location.reload();
        });
    }
    
    function deleteJob(jobId) {
        if (confirm('√ätes-vous s√ªr de vouloir supprimer cette candidature ?')) {
            window.location.href = '/delete/' + jobId;
        }
    }

    function showLM(id) {
        const elt = document.getElementById('lm-content-' + id);
        const modalBody = document.getElementById('lmModalBody');
        if (elt && modalBody) {
            // use textContent to avoid interpreting HTML
            modalBody.textContent = elt.textContent || elt.innerText || '';
            var myModal = new bootstrap.Modal(document.getElementById('lmModal'));
            myModal.show();
        }
    }
</script>
{% if not user.is_reader %}
<div class="mb-3">
    <a href="{{ url_for('new') }}" class="btn btn-primary btn-sm">‚ûï Ajouter une candidature</a>
</div>
{% endif %}
<main class="container-fluid">
{% if jobs %}
    <!-- Desktop table -->
    <div class="d-none d-lg-block">
        <table class="table table-striped table-hover">
            <thead class="table-dark">
            <tr>
                {% if not user.is_reader %}<th>Update</th><th>Delete</th>{% endif %}
                <th>Offre</th><th>Capture</th><th>LM</th><th>Location</th><th>Company</th><th>Contact</th><th>E-Mail</th><th>Date candidature</th><th>Date relance</th><th>Date refus</th><th>Expir√©e</th>
            </tr>
            </thead>
            <tbody>
            {% for job in jobs %}
            <tr class="{% if not job.active %}table-secondary{% endif %}">
                {% if not user.is_reader %}<td><a href="{{ url_for('update', id=job.id) }}" class="btn btn-sm btn-primary" title="Modifier #{{job.id}}">‚úèÔ∏è</a></td><td><button onclick="deleteJob({{ job.id }})" class="btn btn-sm btn-danger" title="Supprimer #{{job.id}}">üóëÔ∏è</button></td>{% endif %}
                <td><a href="{{ job.url }}" target="_blank">{{ job.name }}</a></td>
                <td>{% if job.is_capture %}{% set capture = 'images/' + ('capture_%s.pdf' % job.id) %}<a href="{{ url_for('static', filename=capture) }}" target="_blank" class="btn btn-sm btn-outline-success">PDF</a>{% else %}<span class="text-muted">‚åê</span>{% endif %}</td>
                <td>
                    {% if job.cover_letter_text %}
                        <span class="text-truncate d-inline-block" style="max-width:160px">{{ job.cover_letter_text }}</span>
                        <button type="button" class="btn btn-sm btn-link p-0 ms-2" onclick="showLM({{ job.id }})">Aper√ßu</button>
                        <div id="lm-content-{{ job.id }}" class="d-none">{{ job.cover_letter_text | e }}</div>
                    {% else %}
                        <span class="text-muted">‚Äî</span>
                    {% endif %}
                </td>
                <td>{{ job.zipCode }}</td><td>{{ job.company }}</td><td>{{ job.contact }}</td>
                <td class="{% if not job.email %}bg-warning{% endif %}">{{ job.email }}</td>
                <td class="{% if job.expired %}bg-danger text-white{% endif %}">{{job.applicationDate.strftime('%d/%m/%Y')}}</td>
                <td>{% if job.relaunchDate %}{{job.relaunchDate.strftime('%d/%m/%Y')}}{% endif %}</td>
                <td>{% if job.refusalDate %}{{job.refusalDate.strftime('%d/%m/%Y')}}{% endif %}</td>
                <td><input type="checkbox" class="form-check-input" {% if not user.is_reader %}onchange="toggleExpired({{ job.id }})"{% else %}disabled{% endif %} {% if not job.active %}checked{% endif %}></td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- Mobile cards -->
    <div class="d-lg-none">
        {% for job in jobs %}
        <div class="card mb-2 {% if not job.active %}bg-light{% endif %}">
            <div class="card-body p-2">
                <div class="d-flex justify-content-between align-items-start mb-1">
                    <h6 class="card-title mb-0 small"><a href="{{ job.url }}" target="_blank">{{ job.name }}</a></h6>
                    {% if not user.is_reader %}
                        <a href="{{ url_for('update', id=job.id) }}" class="btn btn-sm btn-primary me-1" title="Modifier #{{job.id}}">‚úèÔ∏è</a>
                        <button onclick="deleteJob({{ job.id }})" class="btn btn-sm btn-danger" title="Supprimer #{{job.id}}">üóëÔ∏è</button>
                    {% endif %}
                </div>
                <div class="small text-muted mb-1"><strong>{{ job.company }}</strong> - {{ job.zipCode }}</div>
                <div class="small mb-1">{{ job.contact }} {% if job.email %}- {{ job.email }}{% endif %}</div>
                <div class="d-flex justify-content-between align-items-center small">
                    <span class="{% if job.expired %}bg-danger text-white px-1 rounded{% endif %}">{{job.applicationDate.strftime('%d/%m')}}</span>
                    <div>
                        {% if job.is_capture %}{% set capture = 'images/' + ('capture_%s.pdf' % job.id) %}<a href="{{ url_for('static', filename=capture) }}" target="_blank" class="btn btn-sm btn-outline-success py-0">PDF</a>{% endif %}
                        {% if job.cover_letter_text %}
                            <span class="ms-1 small text-truncate" style="max-width:120px">{{ job.cover_letter_text }}</span>
                            <button type="button" class="btn btn-sm btn-link p-0 ms-2" onclick="showLM({{ job.id }})">Aper√ßu</button>
                            <div id="lm-content-{{ job.id }}" class="d-none">{{ job.cover_letter_text | e }}</div>
                        {% endif %}
                        <input type="checkbox" class="form-check-input ms-2" {% if not user.is_reader  %}onchange="toggleExpired({{ job.id }})"{% else %}disabled{% endif %} {% if not job.active %}checked{% endif %} title="Expir√©e">
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="text-center mt-5"><p class="fs-5">Pas de candidature en cours ‚úåÔ∏è</p></div>
    {% endif %}
</main>

<!-- Modal for cover letter preview -->
<div class="modal fade" id="lmModal" tabindex="-1" aria-labelledby="lmModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="lmModalLabel">Aper√ßu - Lettre de motivation</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="lmModalBody" style="white-space:pre-wrap;"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
      </div>
    </div>
  </div>
</div>

{% endblock main %}
